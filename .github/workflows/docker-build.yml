name: Build and Push Docker Image

on:
  push:
    branches: [master, main]

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write


    steps:
     - name: check out code
       uses: actions/checkout@v4

     - name: Log in to GitHub Container 
       uses: docker/login-action@v3
       with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

     - name: Build and push docker Image
       uses: docker/build-push-action@v5
       with:
        context: .
        push: true
        tags: ghcr.io/mayyyk/devops_playground:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push


    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Instalujemy zależności Ansible (role i kolekcje)
      # Musimy to zrobić, bo 'action-ansible-playbook' sam tego nie robi
      - name: Install Ansible dependencies
        run: |
          ansible-galaxy collection install community.general community.docker
          ansible-galaxy install geerlingguy.docker -p ./ansible_project/roles
          ansible-galaxy install geerlingguy.node_exporter -p ./ansible_project/roles

      - name: Run Ansible Playbook
        uses: dawidd6/action-ansible-playbook@v2
        with:
          # Ścieżka do playbooka w repozytorium
          playbook: configure-server.yml
          
          # Katalog roboczy, w którym znajdują się wszystkie pliki Ansible
          directory: ./ansible_project 
          
          # Klucz SSH do logowania na serwer (z GitHub Secrets)
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          
          # Hasło do sejfu Ansible (z GitHub Secrets)
          vault_password: ${{ secrets.ANSIBLE_VAULT_PASS }}
          
          # Przekazujemy adres IP i użytkownika dynamicznie
          # To zastępuje użycie pliku 'inventory.ini'
          inventory: |
            [web]
            ${{ secrets.SERVER_IP }} ansible_user=root
     
